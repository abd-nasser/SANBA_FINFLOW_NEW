<dialog id="clientModal" class="modal">
  <div class="modal-box max-w-2xl max-h-[90vh] overflow-y-auto">
    
    <!-- En-tête -->
    <div class="sticky top-0 bg-base-100 pb-4 mb-6">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h2 class="text-2xl font-bold">Ajouter un Nouveau Client</h2>
          <p class="text-sm opacity-70">Remplissez les informations du client</p>
        </div>
        <button onclick="clientModal.close()" class="btn btn-sm btn-circle btn-ghost">✕</button>
      </div>
      
      <!-- Messages d'erreur globaux -->
      {% if form.non_field_errors %}
      <div class="alert alert-error mb-4">
    
        <div>
          {% for error in form.non_field_errors %}
          <p>{{ error }}</p>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Formulaire -->
    <form method="post" action="{% url 'client_app:ajouter-client' %}" novalidate class="space-y-8">
      {% csrf_token %}
      
      <!-- Type de client -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-bold text-lg">Type de client *</span>
        </label>
        {{ form.type_client }}
        {% if form.type_client.errors %}
        <div class="mt-2 text-error text-sm">
          {% for error in form.type_client.errors %}
          <p>⚠️ {{ error }}</p>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      <!-- Section 1: Identité -->
      <div class="card bg-base-200 p-6">
        <h3 class="text-lg font-bold mt-4 flex items-center gap-2">
          Identité
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Raison sociale (conditionnelle) -->
          <div id="raison-sociale-field" class="form-control md:col-span-2">
            <label class="label">
              <span class="label-text font-medium">Raison sociale</span>
            </label>
            {{ form.raison_sociale }}
            {% if form.raison_sociale.errors %}
            <div class="mt-1 text-error text-sm">
              {% for error in form.raison_sociale.errors %}
              <p>{{ error }}</p>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Nom *</span>
            </label>
            {{ form.nom }}
            {% if form.nom.errors %}
            <div class="mt-1 text-error text-sm">
              {% for error in form.nom.errors %}
              <p>{{ error }}</p>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Prénom</span>
            </label>
            {{ form.prenom }}
          </div>

          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">date naissance</span>
            </label>
            {{ form.date_de_naissance }}
          </div>

        </div>
      </div>
      

      <!-- Section 2: Coordonnées -->
      <div class="card bg-base-200 p-6">
        <h3 class="text-lg font-bold mt-4 flex items-center gap-2">
          Coordonnées
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Téléphone principal *</span>
            </label>
            {{ form.telephone }}
            {% if form.telephone.errors %}
            <div class="mt-1 text-error text-sm">
              {% for error in form.telephone.errors %}
              <p>{{ error }}</p>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Téléphone secondaire</span>
            </label>
            {{ form.telephone_secondaire }}
          </div>
          
          <div class="form-control md:col-span-2">
            <label class="label">
              <span class="label-text font-medium">Email</span>
            </label>
            {{ form.email }}
          </div>
        </div>
      </div>

      <!-- Section 3: Adresse -->
      <div class="card bg-base-200 p-6">
        <h3 class="text-lg font-bold mt-4 flex items-center gap-2">
          Adresse
        </h3>
        
        <div class="space-y-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Adresse complète *</span>
            </label>
            {{ form.adresse }}
          </div>
          
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium">Pays *</span>
              </label>
              {{ form.pays }}
            </div>
            

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium">Ville *</span>
              </label>
              {{ form.ville }}
            </div>
            
            <div class="form-control">
              <label class="label">
                <span class="label-text font-medium">Quartier</span>
              </label>
              {{ form.quartier }}
            </div>
          </div>
        </div>
      </div>

      <!-- Section 4: Informations métier -->
      <div class="card bg-base-200 p-6">
        <h3 class="text-lg font-bold mt-4 flex items-center gap-2">
          Informations métier
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Secteur d'activité</span>
            </label>
            {{ form.secteur_activite }}
          </div>
          
          <div class="form-control">
            <label class="label">
              <span class="label-text font-medium">Comment nous a-t-il connu ? *</span>
            </label>
            {{ form.source_client }}
          </div>
          
          <div class="form-control md:col-span-2">
            <label class="label">
              <span class="label-text font-medium">Potentiel du client</span>
            </label>
            {{ form.potentiel_client }}
          </div>
        </div>
      </div>

      <div class="form-control">
        <label class="label">
          <span class="label-text font-medium">Client fidel</span>
        </label>
        {{ form.est_fidel }}
      </div>

      <!-- Section 5: Notes -->
      <div class="form-control">
        <label class="label">
          <span class="label-text font-bold text-lg">Notes internes</span>
        </label>
        {{ form.notes_internes }}
        <label class="label">
          <span class="label-text-alt opacity-70">Informations confidentielles sur le client</span>
        </label>
      </div>

      <!-- Boutons -->
      <div class="modal-action sticky bottom-0 bg-base-100 pt-4 border-t">
        <div class="flex w-full justify-between">
          <button type="button" onclick="clientModal.close()" class="btn btn-ghost">
            Annuler
          </button>
          <button type="submit" class="btn btn-creatclient">
            Créer le client
          </button>
        </div>
      </div>
    </form>
  </div>
  
  <!-- Backdrop -->
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>

<!-- Script pour ouvrir et gérer la raison sociale -->
<script>
function openClientModal() {
  document.getElementById('clientModal').showModal();
  // Initialiser la visibilité de la raison sociale
  toggleRaisonSociale();
}

function toggleRaisonSociale() {
  const typeClientSelect = document.querySelector('[name="type_client"]');
  const raisonSocialeField = document.getElementById('raison-sociale-field');
  
  if (typeClientSelect && raisonSocialeField) {
    if (typeClientSelect.value === 'entreprise') {
      raisonSocialeField.style.display = 'block';
    } else {
      raisonSocialeField.style.display = 'none';
    }
    
    // Écouter les changements
    typeClientSelect.addEventListener('change', function() {
      if (this.value === 'entreprise') {
        raisonSocialeField.style.display = 'block';
      } else {
        raisonSocialeField.style.display = 'none';
      }
    });
  }
}

// Initialiser au chargement si le modal est déjà ouvert
document.addEventListener('DOMContentLoaded', toggleRaisonSociale);
</script>


{% if open_client_modal %}
    <script>
    document.addEventListener('DOMContentLoaded', function(){
        openClientModal();
        //toggleRaisonSociale();
    })
    </script>

{% endif %}
    
