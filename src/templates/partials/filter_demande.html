 {% load humanize %}
<div class=" table_container card bg-white shadow-lg" id="table_container">
    <div class="card-body p-0">
        <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="font-bold">R√©f√©rence</th>
                        <th class="font-bold">Demandeur</th>
                        <th class="font-bold">Montant</th>
                        <th class="font-bold">Chantier</th>
                        <th class="font-bold">Motif</th>
                        <th class="font-bold">Statut</th>
                        <th class="font-bold">Approuv√©/Refus√© par</th>
                        <th class="font-bold">D√©caiss√©</th>
                        <th class="font-bold">Date Demande</th>
                        <th class="font-bold">Date Approbation</th>
                        <th class="font-bold">Date D√©caissement</th>
                        <th class="font-bold no-print">Actions</th>
                    </tr>
                </thead>
                <tbody id="table_body">
                    {% for hist in dmd_decaissmt_hist %}
                    <tr id="table_row_{{ hist.id }}">
                        <td class="font-mono text-sm">
                            <span class="badge badge-outline">{{ hist.reference_demande|default:"-" }}</span>
                        </td>
                        <td class="font-semibold">{{ hist.demandeur.username }}</td>
                        <td class="font-bold text-green-600">
                            {{ hist.montant|floatformat:1|intcomma }} FCFA
                        </td>
                        <td>
                            {% if hist.chantier %}
                                <span class="badge badge-info">{{ hist.chantier }}</span>
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="tooltip" data-tip="{{ hist.motif }}">
                                <span class="line-clamp-1 max-w-[150px]">{{ hist.motif|truncatechars:50 }}</span>
                            </div>
                        </td>
                        <td>
                            {% if hist.status == 'en_attente' %}
                                <span class="status-badge status-en_attente">‚è≥ En attente</span>
                            {% elif hist.status == 'approuvee_directeur' %}
                                <span class="status-badge status-approuvee_directeur">‚úÖ Directeur</span>
                            {% elif hist.status == 'approuvee_comptable' %}
                                <span class="status-badge status-approuvee_comptable">‚úÖ Comptable</span>
                            {% elif hist.status == 'refusee_directeur' %}
                                <span class="status-badge status-refusee_directeur">‚ùå Directeur</span>
                            {% elif hist.status == 'refusee_comptable' %}
                                <span class="status-badge status-refusee_comptable">‚ùå Comptable</span>
                            {% elif hist.decaisse %}
                                <span class="status-badge status-decaisse">üí∞ D√©caiss√©</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if hist.approuve_par %}
                                <span class="badge badge-outline">{{ hist.approuve_par }}</span>
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if hist.decaisse %}
                                <span class="badge badge-success">‚úì Oui</span>
                            {% else %}
                                <span class="badge badge-error">‚úó Non</span>
                            {% endif %}
                        </td>
                        <td class="text-sm">
                            {{ hist.date_demande|date:"d/m/Y" }}
                        </td>
                        <td class="text-sm">
                            {% if hist.date_approbation %}
                                {{ hist.date_approbation|date:"d/m/Y H:i" }}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="text-sm">
                            {% if hist.date_decaissement %}
                                {{ hist.date_decaissement|date:"d/m/Y H:i" }}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </td>
                        <td class="no-print">
                            <div class="flex gap-2">
                                
                                {% if user.is_authenticated and user.post.nom == "S√©cretaire" %}
                                      {% if not hist.decaisse and hist.status == 'approuvee_directeur' or hist.status == 'approuvee_comptable' %}
                                        <a href="{% url 'secretaire_app:valider-decaissement' hist.id %}"
                                        class="btn btn-xs btn-success">
                                            üí∞ D√©caisser
                                        </a>
                                        {% endif %}
                                {% endif %}
                                    
                              
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="12" class="text-center py-12">
                            <div class="text-5xl mb-4">üì≠</div>
                            <h3 class="text-xl font-semibold text-gray-500 mb-2">Aucune demande trouv√©e</h3>
                            <p class="text-gray-400">Essayez de modifier vos filtres de recherche</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot >
                    <tr>
                        <th colspan="2" class="text-right font-bold">TOTAL :</th>
                        <th class="font-bold text-green-700">
                            {{ total_general_filter|floatformat:1|default:"0" }} FCFA
                        </th>
                        <th colspan="8"></th>
                        <th class="no-print">
                            <span class="text-sm text-gray-500">
                                {{ dmd_decaissmt_hist|length }} demande(s)
                            </span>
                        </th>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if dmd_decaissmt_hist.has_other_pages %}
        <div class="card-actions justify-center p-6 border-t">
            <div class="join">
                {% if dmd_decaissmt_hist.has_previous %}
                    <a class="join-item btn"
                       hx-get="{% url 'secretaire_app:hist-demande-decaisse' %}?page={{ dmd_decaissmt_hist.previous_page_number }}"
                       hx-target="#dmd_list">&laquo;</a>
                {% endif %}
                
                {% for i in dmd_decaissmt_hist.paginator.page_range %}
                    {% if dmd_decaissmt_hist.number == i %}
                        <a class="join-item btn btn-active">{{ i }}</a>
                    {% else %}
                        <a class="join-item btn"
                           hx-get="{% url 'secretaire_app:hist-demande-decaisse' %}?page={{ i }}"
                           hx-target="#dmd_list">{{ i }}</a>
                    {% endif %}
                {% endfor %}
                
                {% if dmd_decaissmt_hist.has_next %}
                    <a class="join-item btn"
                       hx-get="{% url 'secretaire_app:hist-demande-decaisse' %}?page={{ dmd_decaissmt_hist.next_page_number }}"
                       hx-target="#dmd_list">&raquo;</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
    function showDetails(id) {
        // R√©cup√©rer les d√©tails complets via HTMX ou modal
        fetch(`/api/demande/${id}/`)
            .then(response => response.json())
            .then(data => {
                // Afficher modal avec d√©tails
                alert(`D√©tails demande ${id}:\nMontant: ${data.montant} FCFA\nMotif: ${data.motif}`);
            });
    }
</script>