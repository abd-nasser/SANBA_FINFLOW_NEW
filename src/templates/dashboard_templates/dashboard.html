{% extends 'dashboard_templates/dash_base.html' %}


{% block title %}
    Dashbord SSM
{% endblock title %}
    

{% block content %}
    <div class="stat">
            <h1> Dashbord Sanba structure Metallique</h1>
            <p>Date: {{ "now"|date:"d/m/Y"}}</p>

            
            <!-- SECTION ALERTES-->
            
            {% if alerts %}
                <div>
                    <h2>Alertes</h2>
                    
                    {% for alert  in alerts %}
                       <p> aletre : {{ alert.type }}</p>
                       <strong> ring ring {{ alert.message}}</strong> 
                       <a href="{{ alert.lien }}">Voir</a>
                    {% endfor %}
                        
                </div>
            {% endif %}

            <!--  SECTION KPI CARDS (les chiffres importants)-->
            <div>
                <h2>Indicateur cl√©</h2>

                <div class="kpi-and-dash-client">
                    <div>
                        <h3> Clients</h3>

                        <p> Nombres de  clients au total:<strong>{{ total_client }}</strong></p>
                        <p> Nombre de nouveaux clients de ce mois :<strong>{{ nouveaux_clients_mois }}</strong> </p>
                        <p> Nombre de client fid√®le <strong>{{ clients_fideles }}</strong> N</p>
                    </div>

                <!--SECTION Tableau: top Clients par argent-->
                <div class='top_Clients'>
                    <h3> Top 5 Clients par Chiffre d'affaire</h3>
                    <table border="1" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Type</th>
                                <th>Ville</th>
                                <th>Chiffre d'affaire Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {%for client in top_clients_ca %}
                            <tr>
                                <td>
                                    
                                    {% if client.type_client == 'entreprise' %}
                                        {{client.raison_sociale}}
                                        {% else %}
                                        {{client.nom}} {{client.prenom}}
                                    {% endif %}
                                        
                                </td>
                                <td>{{ client.get_type_client_display }}</td>
                                <td>{{ client.ville }}</td>
                                <td>{{ client.total_ca|default:0|floatformat:0 }} FCFA</td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="4">Aucun client avec Chantier</td>
                                </tr>
                            {% endfor %} 
                        </tbody>

                    </table>

                </div>


<br>
                <div class="kpi and chart chantier">
                    <div>
                        <h3>Chantier</h3>

                        <p> Nombre total de chantier:<strong>{{total_chantiers}}</strong></p>
                        <p>Chantier actifs : <strong> {{chantiers_actifs}}</strong></p>
                        <p>chantiers termin√© de ce mois: <strong>{{ chantiers_termine_mois }}</strong></p>
                        <p>nombre_chantier_en_retard: <strong>{{ nombre_chantier_en_retard }}</strong></p>
                    </div>

                    <!-- RADAR Chantier Chart-->
                    <div style="margin-top: 40px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <h3>Performance par type de travaux (Radar) </h3>
                        <p class="text-muted">Comparaison multi-m√©triques des differents types de chantiers </p>
                        
                        <div style='height: 400px;'>
                            <canvas id="performanceRadarChart"></canvas>
                        </div>

                        <div class="row mt-3 text-center">
                                <div class="col-3">
                                    <span style="display: inline-block; width: 12px; height: 12px; background: #FF6384; border-radius: 50%;"></span>
                                    <small> Nombre de chantiers</small>
                                </div>
                                <div class="col-3">
                                    <span style="display: inline-block; width: 12px; height: 12px; background: #36A2EB; border-radius: 50%;"></span>
                                    <small> Budget moyen</small>
                                </div>
                                <div class="col-3">
                                    <span style="display: inline-block; width: 12px; height: 12px; background: #FFCE56; border-radius: 50%;"></span>
                                    <small> Dur√©e moyenne</small>
                                </div>
                                <div class="col-3">
                                    <span style="display: inline-block; width: 12px; height: 12px; background: #4BC0C0; border-radius: 50%;"></span>
                                    <small> Efficacit√© (budget/jour)</small>
                                </div>
                            </div>
                        </div>
                    
                    </div>
                  
                </div>


<br>

                <div class="kpi-and-graph-finance">
                        <div>
                            <h3>Finance</h3>
                            <p><strong>{{ chiffre_affaire_total|floatformat:0 }}</strong>Chiffre d'affaire total</p>
                            <p><strong>{{ montant_encaisse_total|floatformat:0 }}</strong>FCFA encaiss√©</p>
                            <p><strong>{{ taux_encaisse_moyen }}%</strong> taux d'encaissement</p>
                        </div>

                        <!--SECTION GRAPH-->
                        <div class='grah-ca_par_mois'>
                            <h2> Evolution du chiffre d'affaire</h2>

                            <div style="height:400px;">
                                <canvas id="caChart"></canvas>
                            </div>
                        </div>

                </div>
                

    </div>



     <!--GRAPHIQUE DEPENSES -->
    <div style="margin-top: 40px">
            <h2> Analytices D√©penses</h2>

            <!-- GRAPH-DONUT 6 D√©penses par cat√©gories -->
            <div >
                <h3>D√©penses par cat√©gorie</h3>
                <div style="height: 400px;">
                        <canvas id="depensesDonutChart"></canvas>
                </div>
                
                <p>Total d√©penses ce mois: <strong>{{total_depenses_mois|floatformat:0}}</strong> FCFA</p>
            </div>

            <!-- GRAPH-BARRES - D√©penses par mois -->
            <div>
                <h3>D√©penses pas Mois</h3>
                <div style="height: 400px;">
                    <canvas id="depensesBarChart"></canvas>
                </div>
            </div>

     </div>

       <!-- TABLEAU TOP 5 types de D√©penses-->
       <div style='margin-top: 30px;'>
        <h3>üèÜ Top 5 Types de D√©penses</h3>
        <table border="1", style="width: 100%;">
            <thead>
                <tr>
                    <th>Type de D√©pense</th>
                    <th>Cat√©gorie</th>
                    <th>Montant Total</th>
                    <th>Nombre d'utilisations</th>
                    <th>poucentage</th>
                </tr>
            </thead>
            <tbody>
                
                {% for depense in depense_par_type|slice:":5" %}
                <tr>
                    <td>{{depense.nom}}</td>
                    <td>
                        <!-- Affiche un point de couleur -->
                        <span style="display: inline-block; width: 10px; height: 10px; background: {{ depense.couleur|default:'#ccc' }}; border-radius: 50%; margin-right: 5px;"></span>
                        {{ depense.categorie }}
                    </td>

                    <td>{{ depense.total_depenses_sum|default:0|floatformat:0}} FCFA</td>
                    <td>{{ depense.nombre_utilisation|default:0 }}</td>
                    <td>{{ depense.total_pourcentage|floatformat:1}}%</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="4" >Aucune d√©pense enregistr√©e</td>
                </tr>
                {% endfor %}
                    
            </tbody>
        </table>
       </div>
     
   



    


        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>    
            //Donn√©e CA(chiffre d'affaire) par mois
            const chiffre_daff_data = {
                labels:[{% for item in ca_par_mois%} "{{ item.mois }}" {% if not forloop.last %}, {%endif%}{% endfor %}],
                // labels = les noms sous le graphique (les mois)
            
            
                values:[{% for item in ca_par_mois%} "{{ item.ca }}" {% if not forloop.last %}, {%endif%}{%endfor%}]
                // values = les chiffre (l'argent)
            };
            document.addEventListener("DOMContentLoaded", function(){
                const caCtx = document.getElementById('caChart').getContext('2d');
                new Chart(caCtx,{
                    type: 'line', //type de graphique = ligne
                    data:{
                        labels: chiffre_daff_data.labels, // les mois
                        datasets:[{ // une seule serie de donn√©es
                            
                            label:'Chiffre d\'affaire(FCFA)', //nom de la courbe
                            data: chiffre_daff_data.values, // Les chiffres
                            borderColor: 'rgb(75, 192, 192)',// Couleur de la ligne
                            tension: 0.2,
                            fill: true,
                            backgroundColor: 'rgb(75, 192, 192, 0.2)' 
                        }]
                    },
                    options:{
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value){
                                        // montre "1,000,000" au lieu de "1000000"
                                        return value.toLocaleString() + 'FCFA'
                                    }
                                }
                            }
                        }

                    }

                }

                )
            });

            //===================================== 2. GRAPHIQUE DONUT - DEPENSES PAR CATEGORIE =======================================
            // R√©cup√®re le canvas pour le graphique DONUT
            const donutCtx = document.getElementById("depensesDonutChart").getContext('2d');

            //Donn√©e pour le donut : cat√©gories et pourcentages et couleur
            //1-data_depense-Categorie
            const categoriesDonut = [{% for cat in depenses_par_categorie %} '{{ cat.categorie }}'
            {% if not forloop.last %}, {% endif %}{% endfor %}];

            //2-data-depense_Pourcentage
            const pourcentageDonut = [{% for cat in depenses_par_categorie %} {{ cat.total_pourcentage|floatformat:1 }}
            {% if not forloop.last %}, {% endif %}{% endfor %}];

            //3-data_depense-categorir-couleur
            const couleurDonut = [{% for cat in depenses_par_categorie %}'{{ cat.couleur }}'
            {% if not forloop.last %}, {% endif %}{% endfor %}];

            //Cr√©ations du graphique donut
            new Chart(donutCtx, {
                type: 'doughnut', // type: donut (cercle avec trou)
                data: {
                    labels: categoriesDonut, // nons des cat√©gories (ex: "Materiaux, Transport")
                    datasets: [{
                        data: pourcentageDonut, // Pourcentages de chaque cat√©gories
                        backgroundColor: couleurDonut, // les Couleur de chaque cat√©gorie
                        borderWidth: 1  // Epaisseur de la bordure des parts
                    }]

                },


                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right'    // L√©gende √† droite du graphique
                        },
                        tooltip: {               // Info-bulle au survol
                            callbacks: {
                                // Personnalise l'affichage de l'info-bulle
                                label: function(context) {
                                    return context.label + ': ' + context.raw.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }

            });


            //===================================== 3. GRAPHIQUE BARRES - DEPENSES PAR MOIS =======================================
            // r√©cup√®re le canvas pour le graphique BARRES
            const barCtx = document.getElementById("depensesBarChart").getContext('2d');

            // Donn√©es pour les barres: mois et montants 
            const moisBarres = [{% for item in depense_par_mois %} '{{ item.mois|date:"M Y" }}'
            {% if not forloop.last %}, {% endif %}{%  endfor %}];

            const montantsBarres = [{% for item in depense_par_mois %} {{ item.total }}
            {% if not forloop.last %}, {% endif %} {% endfor %}];

            //Cr√©ations du graphique barres
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: moisBarres,
                    datasets: [{
                        label: 'D√©penses (FCFA)',
                        data: montantsBarres,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',  // Bleu transparent
                        borderColor: 'rgba(54, 162, 235, 1)',        // Bleu solide
                        borderWidth: 1           // √âpaisseur de la bordure des barres

                    }]
                },
                
            })

            //===================================== 4. GRAPHIQUE RADAR - PERFORMANCE CHANTIER =======================================
            const radarCtx = document.getElementById('performanceRadarChart').getContext('2d');

            // Donn√©es depuis Django
            const radarLabels = [{% for item in radar_performance_data %}'{{ item.label }}'
            {% if not forloop.last %}, {% endif %}{% endfor %}];
            
            const radarDatasets = [
                {
                    label: 'Nombre de chantiers',
                    data: [{% for item in radar_performance_data %}{{ item.nombre_norm|floatformat:1 }}
                    {% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: '#FF6384',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    pointBackgroundColor: '#FF6384',
                },
                {
                    label: 'Budget moyen (normalis√©)',
                    data: [{% for item in radar_performance_data %}{{ item.budget_norm|floatformat:1 }}
                    {% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: '#36A2EB',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    pointBackgroundColor: '#36A2EB',
                },
                {
                    label: 'Dur√©e moyenne (normalis√©e)',
                    data: [{% for item in radar_performance_data %}{{ item.duree_norm|floatformat:1 }}
                    {% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: '#FFCE56',
                    backgroundColor: 'rgba(255, 206, 86, 0.2)',
                    pointBackgroundColor: '#FFCE56',
                },
                {
                    label: 'Efficacit√© (normalis√©e)',
                    data: [{% for item in radar_performance_data %}{{ item.efficacite_norm|floatformat:1 }}
                    {% if not forloop.last %}, {% endif %}{% endfor %}],
                    borderColor: '#4BC0C0',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    pointBackgroundColor: '#4BC0C0',
                }
            ];
            
            new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: radarLabels,
                    datasets: radarDatasets
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            angleLines: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            suggestedMin: 0,
                            suggestedMax: 100,
                            ticks: {
                                display: false
                            },
                            pointLabels: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const index = context.dataIndex;
                                    const item = radar_performance_data_json[index]; // Besoin de passer en JSON
                                    
                                    let value = context.raw;
                                    let realValue = '';
                                    
                                    if (label.includes('Nombre')) {
                                        realValue = ` (${item.nombre} chantiers)`;
                                    } else if (label.includes('Budget')) {
                                        realValue = ` (${item.budget_moyen.toLocaleString()} FCFA)`;
                                    } else if (label.includes('Dur√©e')) {
                                        realValue = ` (${item.duree_moyenne} jours)`;
                                    } else if (label.includes('Efficacit√©')) {
                                        realValue = ` (${item.efficacite.toFixed(0)} FCFA/jour)`;
                                    }
                                    
                                    return `${label}: ${value}%${realValue}`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Passe les donn√©es en JSON pour le tooltip
            window.radar_performance_data_json = {{ radar_performance_data|safe }};
       
                    
        </script>



        <!--Bouton D'ACTION-->
        <div style="margin-top: 40px; padding: 20px; border-top: 2px solid #ccc">
            <h3> Actions rapides</h3>
            <div>
                <a href="{% url 'client_app:ajouter-client' %}">‚ûï Ajouter un client</a>
                <a href="{% url 'chantier_app:ajouter-chantier' %}">üèóÔ∏è Nouveau chantier</a>
                <a href="/admin/">‚öôÔ∏è Administration</a>

                <button onclick="window.print()"> üñ®Ô∏è Imprimer le dashboard</button>
            </div>
        </div>

{% endblock content %}
    

